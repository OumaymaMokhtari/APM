{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">KPI Absence</h3>
    <div class="text-muted small">
      Utilisateur: {{ request.user.get_full_name|default:request.user.username }}
    </div>
  </div>

  <form id="absence-form" method="post" novalidate>
    {% csrf_token %}

    <!-- ================= Contexte shift ================= -->
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Date *</label>
        <!-- pré-remplissage si 'obj' existe -->
        <input type="date"
               name="date"
               id="id_date"
               class="form-control"
               value="{{ obj.date|date:'Y-m-d' }}"
               required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Shift *</label>
        <select name="shift" id="id_shift" class="form-select" required>
          <option value="" disabled {% if not obj %}selected{% endif %}>— Choisir —</option>
          <option value="MATIN" {% if obj and obj.shift == 'MATIN' %}selected{% endif %}>Matin</option>
          <option value="SOIR"  {% if obj and obj.shift == 'SOIR'  %}selected{% endif %}>Soir</option>
          <option value="NUIT"  {% if obj and obj.shift == 'NUIT'  %}selected{% endif %}>Nuit</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Effectif *</label>
        <input type="number"
               name="effectif"
               id="id_effectif"
               class="form-control"
               min="1"
               step="1"
               value="{{ obj.effectif|default:'1' }}"
               required>
      </div>

      <!-- SUP en liste déroulante -->
      <div class="col-md-4">
        <label class="form-label">SUP *</label>
        <select name="sup_id" id="id_sup" class="form-select" required>
          <option value="" disabled {% if not obj %}selected{% endif %}>— Sélectionner —</option>
          {% for e in sups %}
            <option value="{{ e.id }}" {% if obj and obj.sup_id == e.id %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <hr class="my-4">

    <!-- ============ Champs numériques par type d'absence ============ -->
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Absent non justifié</label>
        <input type="number" class="form-control k-qty" name="abs_non_justifie" min="0" step="1"
               value="{{ obj.abs_non_justifie|default:'0' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Mis à pied</label>
        <input type="number" class="form-control k-qty" name="mis_a_pied" min="0" step="1"
               value="{{ obj.mis_a_pied|default:'0' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Congé</label>
        <input type="number" class="form-control k-qty" name="conge" min="0" step="1"
               value="{{ obj.conge|default:'0' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Maternité (MAT)</label>
        <input type="number" class="form-control k-qty" name="maternite" min="0" step="1"
               value="{{ obj.maternite|default:'0' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Maladie</label>
        <input type="number" class="form-control k-qty" name="maladie" min="0" step="1"
               value="{{ obj.maladie|default:'0' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Autorisé</label>
        <input type="number" class="form-control k-qty" name="autorise" min="0" step="1"
               value="{{ obj.autorise|default:'0' }}">
      </div>

      <!-- Autre : quantité + motif (motif obligatoire si quantité > 0) -->
      <div class="col-md-6">
        <label class="form-label">Autre</label>
        <div class="input-group">
          <input type="number"
                 class="form-control k-qty"
                 name="autre"
                 id="id_autre_qty"
                 min="0"
                 step="1"
                 value="{{ obj.autre|default:'0' }}">
          <input type="text"
                 class="form-control"
                 name="autre_motif"
                 id="id_autre_motif"
                 placeholder="Préciser (ex. rdv, urgent…)"
                 value="{{ obj.autre_motif|default_if_none:'' }}"
                 {% if not obj or not obj.autre %}disabled{% endif %}>
        </div>
        <div class="form-text {% if not obj or not obj.autre %}d-none{% endif %}" id="id_autre_help">
          Motif obligatoire si quantité &gt; 0.
        </div>        
      </div>
    </div>

    <!-- ===================== Résumé total/taux ===================== -->
    <div class="mt-4">
      <table class="table">
        <tfoot class="table-light">
          <tr>
            <th>Total absences (shift)</th>
            <th class="text-end" id="total_absences">0</th>
            <th class="text-end">Taux d’absence : <span id="taux_absences">0.0%</span></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- ===================== Messages ===================== -->
    <div class="alert alert-danger d-none" id="error_box"></div>
    <div class="alert alert-warning d-none" id="warn_box"></div>

    <!-- ===================== Actions ===================== -->
    <div class="d-flex gap-2 mt-3">
      <a href="{% url 'absence_list' %}" class="btn btn-outline-secondary">Annuler</a>
      <button type="submit" class="btn btn-success" id="btn_save">Enregistrer</button>
    </div>
  </form>
</div>

<script>
(function(){
  // Champs utilisés pour les calculs et la validation
  const qtyInputs = document.querySelectorAll('.k-qty');
  const effectif  = document.getElementById('id_effectif');
  const totalCell = document.getElementById('total_absences');
  const tauxCell  = document.getElementById('taux_absences');
  const errBox    = document.getElementById('error_box');
  const warnBox   = document.getElementById('warn_box');
  const form      = document.getElementById('absence-form');

  // Spécifique au couple "Autre"
  const autreQty   = document.getElementById('id_autre_qty');
  const autreMotif = document.getElementById('id_autre_motif');
  const autreHelp  = document.getElementById('id_autre_help');

  // Activer/désactiver le champ motif selon la quantité
  function toggleAutreMotif(){
    const q = Number(autreQty.value || 0);
    const need = q > 0;
    autreMotif.disabled = !need;
    autreMotif.required = need;
    autreHelp.classList.toggle('d-none', !need);
    if (!need) autreMotif.value = '';
  }

  // Recalcul du total et du taux en live + alertes
  function recalc(){
    let total = 0;
    qtyInputs.forEach(inp => { total += Number(inp.value||0); });
    totalCell.textContent = total;

    const eff = Number(effectif.value||0);
    const taux = eff>0 ? (total/eff*100) : 0;
    tauxCell.textContent = (Math.round(taux*10)/10).toFixed(1) + '%';

    errBox.classList.add('d-none');
    warnBox.classList.add('d-none');

    if(eff>0 && total>eff){
      errBox.textContent = `Total absences (${total}) > Effectif (${eff}).`;
      errBox.classList.remove('d-none');
    } else if(eff>0 && taux >= 20){
      warnBox.textContent = `Taux d’absence élevé (${(Math.round(taux*10)/10).toFixed(1)}%).`;
      warnBox.classList.remove('d-none');
    }

    toggleAutreMotif();
  }

  // Events
  qtyInputs.forEach(inp => inp.addEventListener('input', recalc));
  effectif.addEventListener('input', recalc);
  autreQty.addEventListener('input', toggleAutreMotif);

  // Premier calcul (utile quand on édite un objet existant)
  recalc();

  // Validation finale côté client
  form.addEventListener('submit', (e)=>{
    const eff = Number(effectif.value||0);
    const total = Array.from(qtyInputs).reduce((s,inp)=>s+Number(inp.value||0),0);

    if(!(eff>0)){
      e.preventDefault();
      errBox.textContent = 'Effectif invalide (≥ 1 requis).';
      errBox.classList.remove('d-none');
      return;
    }
    if(total === 0){
      e.preventDefault();
      errBox.textContent = 'Renseigne au moins un type d’absence.';
      errBox.classList.remove('d-none');
      return;
    }
    if(total > eff){
      e.preventDefault();
      errBox.textContent = `Total absences (${total}) > Effectif (${eff}).`;
      errBox.classList.remove('d-none');
      return;
    }
    if(Number(autreQty.value||0) > 0 && !(autreMotif.value||'').trim()){
      e.preventDefault();
      errBox.textContent = 'Merci de préciser le motif si “Autre” > 0.';
      errBox.classList.remove('d-none');
      autreMotif.focus();
      return;
    }
  });
})();
</script>
{% endblock %}
